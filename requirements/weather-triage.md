# Требования: Метео-триаж для XC closed routes

**Версия:** 2.0

---

## 1. Цель

Автоматизированный отбор «больших дней» для замкнутых маршрутов на параплане (closed route / return-to-area). Не пропускать 200+ км closed. Не тратить время на слабые дни.

| Приоритет | Дистанция | Тип |
|-----------|-----------|-----|
| 1 | 200+ км | closed route |
| 2 | 150+ км | closed route |
| 3 | 100+ км | closed route |

FAI-треугольник не обязателен. Open distance не интересен.

---

## 2. Пилот и логистика

| Параметр | Значение |
|----------|----------|
| База | Мюнхен |
| Макс. подъезд | 8 ч на машине |
| Крыло | Спортивный класс |
| Навыки | Очень высокие |
| Retrieve | Соло |
| Ранний выезд | OK |

---

## 3. Регионы

| Приоритет | Район | Якорные старты | Категория |
|-----------|-------|----------------|-----------|
| 1 | Баварские Альпы | Lenggries, Wallberg | Ближний |
| 2 | Kössen | Kössen | Ближний |
| 3 | Тироль | По ситуации | Средний |
| 4 | Южный Тироль | Greifenburg, Speikboden | Средний |
| 5 | Северная Италия | Bassano | Дальний |
| 6 | Швейцария | По ситуации | Только 150+/200+ |
| 7 | Словения | По ситуации | Только 150+/200+ |

**Исключено:** Чехия.

---

## 4. Модельный стек

### D-5…D-1 (среднесрок)
| Модель | Разрешение | Поставщик | Роль |
|--------|------------|-----------|------|
| ECMWF IFS HRES | 0.25° | Open-Meteo `/v1/forecast` | Опорная / скелет |
| ICON Seamless | blend | Open-Meteo `/v1/forecast` | Второй детерминист |
| GFS | ~0.25° | Open-Meteo `/v1/gfs` | BL height, LI, CIN |
| ECMWF ENS (51 чл.) | 0.25° | `ensemble-api.open-meteo.com` | Ансамблевый разброс |
| ICON-EU EPS (40 чл.) | ~7 km | `ensemble-api.open-meteo.com` | Ансамблевый разброс |

### D-2…D-0 (ближний)
| Модель | Разрешение | Поставщик | Роль |
|--------|------------|-----------|------|
| ICON-D2 | 2 km | Open-Meteo `/v1/dwd-icon` | Локальный оверрайд 0–48 ч |
| GeoSphere AROME | 2.5 km | `dataset.api.hub.geosphere.at` | Ключевой хай-рез, полный ряд |
| DWD MOSMIX | точечный | `opendata.dwd.de` | Sanity-check |

**BrightSky forecast — убран.** BrightSky может остаться только как legacy observation API.

---

## 5. Погодные пороги (привязаны к окну)

Все пороги оцениваются **по термическому окну** (09:00–18:00 Europe/Berlin), а не по одной точке.

| Параметр | Порог | Агрегация | Действие |
|----------|-------|-----------|----------|
| Средний ветер 850 hPa | > 5 м/с | mean по окну | Downgrade для closed |
| Порывы 10 м | > 10 м/с | max по окну | Нежелательно; указать где |
| Gust factor (порыв − средний) | > 7 м/с | max по окну | Флаг турбулентности |
| База @13:00 local | < вершины + 1000 м | at_13_local | Downgrade / NO-GO |
| CB min по окну | < вершины + 1000 м | min по окну | LOW_BASE flag |
| Рабочее окно | < 5 ч непрерывно | continuous_flyable_hours | NO-GO |
| Слабый фён | — | — | Допустим, отмечать |
| Сильный фён | — | — | NO-GO |
| Локальный overdev | — | — | Риск, не авто-NO-GO |
| Массовый overdev | — | — | NO-GO |
| CAPE > 1500 J/kg | — | max по окну | HIGH_CAPE flag (overdev risk) |
| CAPE тренд | rising | head/tail | CAPE_RISING flag |
| LI < −4 | — | at_13_local | VERY_UNSTABLE flag |
| Lapse < 5.5 °C/km | — | mean по окну | STABLE flag (weak thermals) |
| SW radiation | — | max по окну | для оценки W* |

### Определение «рабочее окно»
Непрерывный интервал (от 1 ч и более), где одновременно:
- нет организованных осадков (precip ≤ 0.5 mm)
- порывы ≤ 12 м/с
- ветер 10 м ≤ 8 м/с

`continuous_flyable_hours` = длительность самого длинного такого непрерывного отрезка.

---

## 6. Привязка ко времени

### Часовой пояс
Все ключевые оценки — **13:00 local (Europe/Berlin)** с учётом DST.
- CET (зима): 13:00 local = 12:00 UTC
- CEST (лето): 13:00 local = 11:00 UTC

Конвертация через `zoneinfo.ZoneInfo("Europe/Berlin")`, не через захардкоженный оффсет.

### Слои данных (для каждого источника)

**at_13_local** — значения точно в 13:00 local:
| Параметр | Единицы |
|----------|---------|
| temperature_2m | °C |
| dewpoint_2m | °C |
| relative_humidity_2m | % |
| windspeed_10m / windgusts_10m / winddirection_10m | m/s, ° |
| cloudcover (+ low/mid/high) | % |
| precipitation | mm |
| cape | J/kg |
| shortwave_radiation | W/m² |
| temperature_850hPa / temperature_700hPa | °C |
| relative_humidity_850hPa / 700hPa | % |
| windspeed_850hPa / 700hPa | m/s |

**thermal_window_stats** — агрегаты по окну 09:00–18:00 local:
| Статистика | Описание |
|------------|----------|
| min | минимум по окну |
| mean | среднее по окну |
| max | максимум по окну |
| n | кол-во точек |
| head | первые 1–2 значения (09:00–10:00) |
| tail | последние 1–2 значения (17:00–18:00) |
| trend | rising / falling / stable (если ≥ 4 точек) |

Тренд: `late = mean(tail)`, `early = mean(head)`.
- rising: late > early × 1.3
- falling: late < early × 0.7
- stable: иначе

### Ансамблевые агрегаты (для ECMWF ENS, ICON-EU EPS)
Для каждого параметра хранить: **p10, p50, p90, spread** (p90 − p10).

---

## 7. XC-профиль

По умолчанию: **термичный**. Ridge/dynamic — только по запросу.

---

## 8. Шкала оценки

Для каждого района, отдельно по 100/150/200 closed:

| Оценка | Значение |
|--------|----------|
| НЕТ | Нереалистично |
| ВОЗМОЖНО | При удачном стечении |
| РЕАЛЬНО | Уверенный шанс |
| СИЛЬНЫЙ ШАНС | Big day |

---

## 9. Pipeline анализа

### Этап 1 — Стоп-фильтр
Для каждого района: NO-GO / MAYBE / GO-CANDIDATE.
Критерии: осадки, ветер, порывы, gust factor, фён, облачность, база, рабочее окно < 5 ч, CAPE тренд.
Даже для NO-GO — грубая оценка по шкале.

### Этап 2 — Глубокий XC-разбор
Только GO-CANDIDATE и сильные MAYBE.
- База @13:00 local + динамика по окну (thermal_window_stats)
- Сила потоков (средняя/пик/хвосты/стабильность) = W*, BL, lapse
- Влияние sustained wind на закрываемость маршрута
- Gust factor как индикатор турбулентности
- Геометрия closed route

### Этап 3 — Мультимодельная сверка
**Автоматическая**: agreement_score ECMWF HRES vs ICON Seamless at_13_local.
- Параметры сравнения: temperature_2m, windspeed_10m, windgusts_10m, cloudcover, precipitation, cape, windspeed_850hPa
- Допуски: T ±2°C, wind ±2 m/s, gusts ±3 m/s, cloud ±20%, precip ±0.5 mm, CAPE ±200 J/kg
- Согласованность → confidence: HIGH (≥80%) / MEDIUM (≥50%) / LOW (<50%)

**Ансамблевый разброс**: ECMWF ENS + ICON-EU EPS spreads.
- Wind spread > 5 m/s → понижение статуса (max MAYBE)
- CAPE spread > 1000 J/kg → понижение статуса

**Если confidence = LOW и статус GO/STRONG → понижение до MAYBE + флаг LOW_CONFIDENCE.**

### Этап 4 — Финальный ранжир
200+ → 150+ → 100+ closed → риск → время в пути → уверенность прогноза.

---

## 10. Режимы запуска

| Режим | Когда | Фокус |
|-------|-------|-------|
| Предварительный | T−2..3 дня | Отбор кандидатов, разброс ансамблей |
| Подтверждение | Вечер T−1 | Свежие модели, тренд, подтверждение |
| Утренний | Утро T | Только по запросу |

---

## 11. Формат выдачи

1. **Краткий итог** (2–6 строк): лучший вариант, оценки, база, уверенность
2. **Таблица** (3–6 строк): район, статус, оценки, окно, база, ветер, потоки, риски, согласованность, confidence
3. **Лучший вариант**: тайминг, профиль, критичные участки, что сломает день
4. **Остальные**: кратко, при каком сдвиге станут лучшими
5. **Сомнения / Неуверенности**: модельные расхождения, ансамблевый разброс, нехватка данных

Блок «Сомнения» выдаётся **всегда**, даже если расхождений нет (тогда: "Значительных расхождений не обнаружено").

---

## 12. Правила качества

- «Летабельно» ≠ «подходит для big closed day»
- Данные отделять от выводов
- Числа и диапазоны вместо расплывчатых формулировок
- Недостаток данных — указывать явно
- Честный MAYBE лучше ложной уверенности
- База всегда в MSL @13:00 local
- Все метрики привязаны к окну (не к одной точке), кроме at_13_local

---

## 13. Scoring (алгоритм)

| Элемент | Очки |
|---------|------|
| Критический флаг (SUSTAINED_WIND_850, GUSTS_HIGH, PRECIP_13, NO_FLYABLE_WINDOW) | −3 каждый |
| LOW_BASE | −2 |
| Качественный флаг (OVERCAST, STABLE, SHORT_WINDOW, GUST_FACTOR) | −1 каждый |
| Danger (HIGH_CAPE, VERY_UNSTABLE, CAPE_RISING) | −1 каждый |
| Позитивный индикатор | +2 каждый |

Пороги: ≤ −5 NO-GO, ≤ −2 UNLIKELY, ≤ 1 MAYBE, ≤ 4 GO, > 4 STRONG.

Дополнительные правила:
- ≥ 2 критических ИЛИ (≥ 1 критический + LOW_BASE) → NO-GO
- ≥ 1 критический + статус GO/STRONG → MAYBE
- confidence = LOW + статус GO/STRONG → MAYBE + LOW_CONFIDENCE flag
- Large ensemble spread (wind > 5, CAPE > 1000) + GO/STRONG → MAYBE + ENS_*_SPREAD flag
