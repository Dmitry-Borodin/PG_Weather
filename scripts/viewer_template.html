<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PG Weather Triage</title>
<style>
:root {
  --strong:#7c3aed;--go:#16a34a;--maybe:#ca8a04;--unlikely:#ea580c;--nogo:#dc2626;
  --bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;--hover:#f1f5f9;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
  background:var(--bg);color:var(--text);line-height:1.6;padding:0;margin:0}
.wrap{max-width:1320px;margin:0 auto;padding:1rem 1rem 3rem}

/* Header */
.hdr{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);color:white;
  padding:1rem 1.5rem;position:sticky;top:0;z-index:100;
  box-shadow:0 2px 8px rgba(0,0,0,.15)}
.hdr-inner{max-width:1320px;margin:0 auto;display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
.hdr h1{font-size:1.4rem;font-weight:700;white-space:nowrap}
.hdr select{padding:0.4rem 0.7rem;border-radius:6px;border:1px solid rgba(255,255,255,0.3);
  background:rgba(255,255,255,0.15);color:white;font-size:0.95rem;cursor:pointer;
  font-weight:600;min-width:150px}
.hdr select option{color:#1e293b;background:white}
.hdr .meta{font-size:0.8rem;color:rgba(255,255,255,0.7);margin-left:auto}

h2{font-size:1.2rem;margin:1.8rem 0 0.6rem;padding-bottom:0.3rem;
  border-bottom:2px solid var(--border)}
h3{font-size:0.95rem;margin:1rem 0 0.3rem;color:var(--muted)}

/* Badge */
.badge{display:inline-block;padding:0.15em 0.6em;border-radius:6px;
  font-weight:700;font-size:0.8rem;color:white;vertical-align:middle}
.b-STRONG{background:var(--strong)}.b-GO{background:var(--go)}
.b-MAYBE{background:var(--maybe);color:#422006}
.b-UNLIKELY{background:var(--unlikely)}.b-NOGO{background:var(--nogo)}
.b-NODATA{background:#94a3b8}
.b-ERROR{background:#6b7280}

/* Tables */
table{width:100%;border-collapse:collapse;font-size:0.85rem;margin:0.5rem 0 1rem}
th{background:var(--border);padding:0.45rem 0.5rem;text-align:left;font-weight:600;
  position:sticky;top:0;white-space:nowrap}
td{padding:0.4rem 0.5rem;border-bottom:1px solid var(--border);white-space:nowrap}
tr:hover td{background:var(--hover)}
.n{text-align:right;font-variant-numeric:tabular-nums}
.na{color:var(--muted)}
.table-wrap{overflow-x:auto}

/* Section box */
.sbox{background:var(--card);border-radius:10px;padding:1rem;
  box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:1rem}

/* Collapsible details */
details>summary{cursor:pointer;list-style:none;user-select:none}
details>summary::-webkit-details-marker{display:none}

/* Flags */
.flags{margin:0.5rem 0}
.fl{padding:0.15rem 0;font-size:0.85rem}
.fw{color:var(--nogo)}.fw::before{content:'⚠ '}
.fg{color:var(--go)}.fg::before{content:'✓ '}

/* Hourly table */
.htbl th{text-align:center;font-size:0.75rem;padding:0.3rem 0.35rem}
.htbl td{text-align:center;font-size:0.8rem;padding:0.25rem 0.35rem}
.tw{background:#f0fdf4}
.tw-peak{background:#dcfce7;font-weight:600}

/* Summary row toggle */
.sum-row{cursor:pointer;transition:background 0.1s}
.sum-row:hover td{background:#e0f2fe !important}
.sum-row.expanded td{background:#f0f9ff}
.arrow{text-align:center;font-size:0.7rem;color:var(--muted);user-select:none;width:1.5em}

/* Detail row (expanded content) */
.detail-row>td{padding:0 !important;border-bottom:2px solid var(--border)}
.detail-row .cbody{padding:0.75rem 1rem 1rem;background:var(--hover)}
.detail-row:hover>td{background:transparent !important}

/* No data */
.empty{text-align:center;color:var(--muted);padding:3rem;font-size:1.1rem}

/* Footer */
.footer{margin-top:2rem;text-align:center;color:var(--muted);font-size:0.8rem;padding:1rem}

@media(max-width:768px){
  table{font-size:0.78rem}
  th,td{padding:0.3rem}
  .hdr h1{font-size:1.1rem}
  .hdr-inner{gap:0.5rem}
}
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-inner">
    <h1>✈️ PG Weather Triage</h1>
    <select id="ds"></select>
    <div class="meta" id="hdr-meta"></div>
  </div>
</div>

<div class="wrap">
  <div id="m"></div>
  <div class="footer">PG Weather Triage v0.5</div>
</div>

<script>
const R = __REPORTS_DATA__;
const SO = {STRONG:0,GO:1,MAYBE:2,UNLIKELY:3,'NO-GO':4,'NO DATA':5,ERROR:6};
const SC = {STRONG:'strong',GO:'go',MAYBE:'maybe',UNLIKELY:'unlikely','NO-GO':'nogo','NO DATA':'nodata',ERROR:'error'};

function esc(t){if(t==null)return'';return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function fmt(v,u,p){
  if(v==null)return'<span class="na">\u2014</span>';
  if(typeof v==='number'){p=p!=null?p:1;return v.toFixed(p)+(u||'')}
  return String(v)+(u||'');
}
function badge(s){return'<span class="badge b-'+((s||'ERROR').replace(/-/g,'').replace(/ /g,''))+'">'+esc(s)+'</span>'}

/* ── Main render ── */
function render(date){
  const d=R[date];if(!d){document.getElementById('m').innerHTML='<div class="empty">No data</div>';return}
  var forecastDate=d.forecast_date||d.date||date;
  document.getElementById('hdr-meta').textContent=
    'Forecast: '+forecastDate+' \u00b7 Generated: '+d.generated_at+' \u00b7 Sources: '+(d.sources_used||[]).join(', ');

  const locs=(d.locations||[]).slice().sort(function(a,b){
    var sa=(a.assessment||{}).status||'ERROR',sb=(b.assessment||{}).status||'ERROR';
    return(SO[sa]||5)-(SO[sb]||5);
  });

  var h='<h2>\ud83d\udcc5 Forecast for: '+esc(forecastDate)+'</h2>';
  h+=renderRef();
  h+=renderMainTable(locs);
  document.getElementById('m').innerHTML=h;

  /* Attach expand/collapse */
  document.querySelectorAll('.sum-row').forEach(function(row){
    row.addEventListener('click',function(){
      var key=this.dataset.key;
      var det=document.getElementById('det-'+key);
      var arrow=this.querySelector('.arrow');
      if(!det)return;
      if(det.style.display==='none'){
        det.style.display='';arrow.textContent='\u25bc';this.classList.add('expanded');
      }else{
        det.style.display='none';arrow.textContent='\u25b6';this.classList.remove('expanded');
      }
    });
  });
}

/* ── Parameter reference (collapsed above table) ── */
function renderRef(){
  var h='<div class="sbox" style="margin-bottom:0.75rem">';
  h+='<details><summary style="font-size:0.8rem;color:var(--muted);padding:0.3rem 0">';
  h+='\u2139\ufe0f Parameter Reference &amp; Score</summary>';
  h+='<div style="font-size:0.75rem;color:var(--muted);margin:0.5rem 0 0;line-height:1.8">';
  h+='<b>Score</b> \u2014 composite rating. Critical flags (WIND/GUSTS/PRECIP) \u22123 each, LOW_BASE \u22122, quality flags (OVERCAST/STABLE/SHORT_WINDOW) \u22121, danger (HIGH_CAPE/UNSTABLE) \u22121. Each positive +2. ';
  h+='Thresholds: \u2264\u22125 NO\u2011GO, \u2264\u22122 UNLIKELY, \u22641 MAYBE, \u22644 GO, >4 STRONG.<br>';
  h+='<b>Base</b> \u2014 cloudbase MSL (m), estimated from T\u2212Td spread at site elevation. <b>Margin</b> \u2014 cloudbase above peak level (m).<br>';
  h+='<b>W850</b> \u2014 wind at 850\u202fhPa (~1500\u202fm). >5\u202fm/s = closed routes. <b>Gusts</b> \u2014 max 10\u202fm gusts.<br>';
  h+='<b>CAPE</b> \u2014 Convective Available Potential Energy (J/kg). >300 thermals, >700 strong, >1500 storm risk.<br>';
  h+='<b>Lapse</b> \u2014 temperature gradient 850\u2192700\u202fhPa (\u00b0C/km). Dry adiabatic = 9.8. >7 strong instability, <5.5 weak thermals.<br>';
  h+='<b>BL</b> \u2014 Boundary Layer height (m). Max thermal height. > peaks = thermals above summits.<br>';
  h+='<b>W*</b> \u2014 Deardorff convective velocity (m/s). Thermal strength: <0.5 weak, 0.5\u20131.5 moderate, >1.5 good, >2.5 strong.<br>';
  h+='<b>LI</b> \u2014 Lifted Index. <0 unstable, <\u22124 storm risk. <b>CIN</b> \u2014 Convective Inhibition (J/kg). <\u221250 suppresses convection.<br>';
  h+='<b>Window</b> \u2014 thermal hours where W*\u22651.5\u202fm/s, base margin\u22651000\u202fm, no precipitation.';
  h+='</div></details></div>';
  return h;
}

/* ── Main table with expandable detail rows ── */
function renderMainTable(locs){
  var NC=17;
  var h='<div class="sbox"><div class="table-wrap"><table>';
  h+='<thead><tr>';
  h+='<th style="width:1.5em"></th>';
  h+='<th>Location</th><th>Drive</th><th>Status</th><th class="n">Score</th>';
  h+='<th class="n">Base, m</th><th class="n">Margin, m</th>';
  h+='<th class="n">W850</th><th class="n">Gusts</th>';
  h+='<th class="n">CAPE</th><th class="n">Lapse</th>';
  h+='<th class="n">BL, m</th><th class="n">W*</th>';
  h+='<th class="n">Cloud %</th><th class="n">LI</th><th class="n">Precip</th>';
  h+='<th>Window</th>';
  h+='</tr></thead>';

  locs.forEach(function(r){
    var a=r.assessment||{};
    var twh=a.thermal_window_hours||0;
    var tw=twh>0?(a.thermal_window_start+'\u2013'+a.thermal_window_end+' ('+twh+'h)'):'\u2014';

    /* Summary row */
    h+='<tr class="sum-row" data-key="'+(r.key||'')+'">';
    h+='<td class="arrow">\u25b6</td>';
    h+='<td><strong>'+esc(r.location)+'</strong></td>';
    h+='<td>'+fmt(r.drive_h,'h')+'</td>';
    h+='<td>'+badge(a.status)+'</td>';
    h+='<td class="n">'+(a.score!=null?a.score:'\u2014')+'</td>';
    h+='<td class="n">'+fmt(a.cloudbase_msl,'',0)+'</td>';
    h+='<td class="n">'+fmt(a.base_margin_over_peaks,'',0)+'</td>';
    h+='<td class="n">'+fmt(a.wind_850hPa_ms,'',1)+'</td>';
    h+='<td class="n">'+fmt(a.gusts_10m_ms,'',1)+'</td>';
    h+='<td class="n">'+fmt(a.cape_J_per_kg,'',0)+'</td>';
    h+='<td class="n">'+fmt(a.lapse_rate_C_per_km,'',1)+'</td>';
    h+='<td class="n">'+fmt(a.boundary_layer_height_m,'',0)+'</td>';
    h+='<td class="n">'+fmt(a.wstar_ms,'',2)+'</td>';
    h+='<td class="n">'+fmt(a.cloudcover_pct,'',0)+'</td>';
    h+='<td class="n">'+fmt(a.lifted_index)+'</td>';
    h+='<td class="n">'+fmt(a.precipitation_mm,'',1)+'</td>';
    h+='<td>'+tw+'</td>';
    h+='</tr>';

    /* Detail row (collapsed by default) */
    h+='<tr id="det-'+(r.key||'')+'" class="detail-row" style="display:none">';
    h+='<td colspan="'+NC+'"><div class="cbody">';
    h+=renderCardBody(r);
    h+='</div></td></tr>';
  });

  h+='</table></div></div>';
  return h;
}

/* ── Card body (expanded detail content) ── */
function renderCardBody(r){
  var a=r.assessment||{};
  var h='';

  if(r.error){return'<p style="color:var(--nogo)">Error: '+esc(r.error)+'</p>';}

  /* Flags */
  var flags=a.flags||[],pos=a.positives||[];
  if(flags.length||pos.length){
    h+='<div class="flags">';
    flags.forEach(function(f){h+='<div class="fl fw"><strong>'+esc(f.tag)+'</strong>: '+esc(f.msg)+'</div>'});
    pos.forEach(function(p){h+='<div class="fl fg"><strong>'+esc(p.tag)+'</strong>: '+esc(p.msg)+'</div>'});
    h+='</div>';
  }

  /* Hourly profile */
  var hp=(r.hourly_analysis||{}).hourly_profile||[];
  if(hp.length){
    h+='<h3>Hourly Profile <span style="font-weight:400;font-size:0.75rem;color:var(--muted)">(ICON-D2 \u2192 GFS fallback \u00b7 BL/CAPE/W* from GFS)</span></h3>';
    h+='<div class="table-wrap"><table class="htbl">';
    h+='<tr><th>Hour</th><th>T, \u00b0C</th><th>Dew, \u00b0C</th><th>Base, m</th><th>Cloud, %</th><th>Precip, mm</th>';
    h+='<th>W850, m/s</th><th>Gusts, m/s</th><th>Lapse, \u00b0C/km</th><th>BL, m</th><th>CAPE, J/kg</th><th>W*, m/s</th></tr>';

    var tws=a.thermal_window_start,twe=a.thermal_window_end,twp=a.thermal_window_peak;
    var twsI=tws?parseInt(tws):99,tweI=twe?parseInt(twe):-1;

    hp.forEach(function(item){
      var hrI=parseInt(item.hour);
      var cls='';
      if(hrI>=twsI&&hrI<=tweI){cls=item.hour===twp?' class="tw-peak"':' class="tw"'}
      h+='<tr'+cls+'>';
      h+='<td><strong>'+item.hour+'</strong></td>';
      h+='<td>'+fmt(item.temp_2m,'',1)+'</td>';
      h+='<td>'+fmt(item.dewpoint,'',1)+'</td>';
      h+='<td>'+fmt(item.cloudbase_msl,'',0)+'</td>';
      h+='<td>'+fmt(item.cloudcover,'',0)+'</td>';
      h+='<td>'+fmt(item.precipitation,'',1)+'</td>';
      h+='<td>'+fmt(item.wind_850,'',1)+'</td>';
      h+='<td>'+fmt(item.gusts,'',1)+'</td>';
      h+='<td>'+fmt(item.lapse_rate,'',1)+'</td>';
      h+='<td>'+fmt(item.bl_height,'',0)+'</td>';
      h+='<td>'+fmt(item.cape,'',0)+'</td>';
      var ws=item.wstar;
      h+='<td'+(ws!=null&&ws>=1.0?' style="color:var(--go);font-weight:600"':'')+'>'+fmt(ws,'',2)+'</td>';
      h+='</tr>';
    });
    h+='</table></div>';
  }

  /* MOSMIX data */
  var mosmix=(r.sources||{}).mosmix||{};
  if(mosmix&&!mosmix.error){
    var mh=mosmix.hourly||{};
    var params=Object.keys(mh);
    if(params.length){
      h+='<h3>DWD MOSMIX ('+esc(mosmix.station_name||'?')+')</h3>';
      var allH={};params.forEach(function(p){Object.keys(mh[p]).forEach(function(hr){allH[hr]=1})});
      var sortH=Object.keys(allH).sort();
      var targetH=sortH.filter(function(hr){return['06:00','09:00','12:00','15:00','18:00'].indexOf(hr)>=0});
      if(targetH.length){
        h+='<div class="table-wrap"><table class="htbl">';
        h+='<tr><th>Param</th>'+targetH.map(function(hr){return'<th>'+hr+'</th>'}).join('')+'</tr>';
        params.forEach(function(p){
          h+='<tr><td><strong>'+esc(p)+'</strong></td>';
          h+=targetH.map(function(hr){return'<td>'+fmt(mh[p][hr])+'</td>'}).join('');
          h+='</tr>';
        });
        h+='</table></div>';
      }
    }
  }

  /* Model comparison */
  var mm=((r.sources||{}).multimodel||{}).at_13||{};
  if(Object.keys(mm).length){
    h+='<h3>Model Comparison @13:00</h3><table style="text-align:center">';
    h+='<tr><th style="text-align:left">Parameter</th><th style="text-align:center">ICON</th><th style="text-align:center">GFS</th><th style="text-align:center">ECMWF</th></tr>';
    var models=['icon_seamless','gfs_seamless','ecmwf_ifs025'];
    ['temperature_2m','dewpoint_2m','cape','cloudcover','windspeed_10m','windgusts_10m','precipitation'].forEach(function(pb){
      h+='<tr><td style="text-align:left"><strong>'+esc(pb)+'</strong></td>';
      h+=models.map(function(m){return'<td style="text-align:center">'+fmt(mm[pb+'_'+m])+'</td>'}).join('');
      h+='</tr>';
    });
    h+='</table>';
  }

  /* Meteo-Parapente data */
  var mp=(r.sources||{}).meteo_parapente||{};
  var mpApis=mp.captured_api||[];
  var mpData=null;
  mpApis.forEach(function(a){if(a.type==='json'&&(a.url||'').indexOf('data.php')>=0)mpData=a.data});
  if(mpData&&mpData.data){
    h+='<h3>\ud83c\udfa8 Meteo-Parapente (hi-res thermals)</h3>';
    var mpHours=mpData.data;
    var mpTarget=['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00'];
    var mpAvail=mpTarget.filter(function(hr){return mpHours[hr]});
    if(mpAvail.length){
      h+='<div class="table-wrap"><table class="htbl">';
      h+='<tr><th>Param</th>'+mpAvail.map(function(hr){return'<th>'+hr+'</th>'}).join('')+'</tr>';
      h+='<tr><td><strong>PBL height</strong></td>';
      h+=mpAvail.map(function(hr){return'<td>'+fmt(mpHours[hr].pblh,'m',0)+'</td>'}).join('');
      h+='</tr>';
      ['cfracl','cfracm','cfrach'].forEach(function(p){
        var label={cfracl:'Cloud low%',cfracm:'Cloud mid%',cfrach:'Cloud high%'}[p];
        h+='<tr><td><strong>'+label+'</strong></td>';
        h+=mpAvail.map(function(hr){return'<td>'+fmt(mpHours[hr][p],'%',0)+'</td>'}).join('');
        h+='</tr>';
      });
      h+='<tr><td><strong>Rain mm</strong></td>';
      h+=mpAvail.map(function(hr){return'<td>'+fmt(mpHours[hr].raintot,'',1)+'</td>'}).join('');
      h+='</tr>';
      h+='<tr><td><strong>Max thermal m/s</strong></td>';
      h+=mpAvail.map(function(hr){
        var ths=mpHours[hr].ths||[];
        var mx=0;ths.forEach(function(v){if(v>mx)mx=v});
        return'<td'+(mx>=0.5?' style="color:var(--go);font-weight:600"':'')+'>'+mx.toFixed(2)+'</td>';
      }).join('');
      h+='</tr>';
      h+='<tr><td><strong>Thermal top m</strong></td>';
      h+=mpAvail.map(function(hr){
        var ths=mpHours[hr].ths||[];var z=mpHours[hr].z||[];
        var top=0;for(var i=0;i<ths.length;i++){if(ths[i]>0.05)top=z[i]}
        return'<td>'+fmt(top,'',0)+'</td>';
      }).join('');
      h+='</tr>';
      h+='</table></div>';
    }
  }

  /* XContest flights */
  var xc=(r.sources||{}).xccontest||{};
  if(xc.flight_count>0){
    h+='<h3>\u2708\ufe0f XContest: '+xc.flight_count+' flights nearby</h3>';
    var xfl=xc.flights_near||[];
    if(xfl.length){
      h+='<table><tr><th>Pilot</th><th>Launch</th><th>Distance</th><th>Type</th></tr>';
      xfl.slice(0,10).forEach(function(fl){
        h+='<tr><td>'+esc(fl.pilot)+'</td><td>'+esc(fl.launch)+'</td>';
        h+='<td>'+esc(fl.distance)+'</td><td>'+esc(fl.type)+'</td></tr>';
      });
      h+='</table>';
    }
  }else if(xc.source==='xccontest'){
    h+='<h3>\u2708\ufe0f XContest: no flights nearby</h3>';
  }

  return h;
}

/* ── Init ── */
(function(){
  var dates=Object.keys(R).sort().reverse();
  var sel=document.getElementById('ds');
  dates.forEach(function(d){
    var opt=document.createElement('option');
    opt.value=d;
    var rd=R[d]||{};
    var fc=rd.forecast_date||rd.date||d;
    var gt=rd.generated_at||'';
    opt.textContent=fc+' ('+gt+')';
    sel.appendChild(opt);
  });
  sel.addEventListener('change',function(){render(sel.value)});
  if(dates.length)render(dates[0]);
})();
</script>
</body>
</html>
