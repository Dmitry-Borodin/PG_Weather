<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PG Weather Triage</title>
<style>
:root {
  --strong:#7c3aed;--go:#16a34a;--maybe:#ca8a04;--unlikely:#ea580c;--nogo:#dc2626;
  --bg:#f8fafc;--card:#fff;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;--hover:#f1f5f9;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
  background:var(--bg);color:var(--text);line-height:1.6;padding:0;margin:0}
.wrap{max-width:1400px;margin:0 auto;padding:1rem 1rem 3rem}
.hdr{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);color:white;
  padding:1rem 1.5rem;position:sticky;top:0;z-index:100;
  box-shadow:0 2px 8px rgba(0,0,0,.15)}
.hdr-inner{max-width:1400px;margin:0 auto;display:flex;align-items:center;gap:1rem;flex-wrap:wrap}
.hdr h1{font-size:1.4rem;font-weight:700;white-space:nowrap}
.hdr select{padding:0.4rem 0.7rem;border-radius:6px;border:1px solid rgba(255,255,255,0.3);
  background:rgba(255,255,255,0.15);color:white;font-size:0.95rem;cursor:pointer;
  font-weight:600;min-width:150px}
.hdr select option{color:#1e293b;background:white}
.hdr .meta{font-size:0.8rem;color:rgba(255,255,255,0.7);margin-left:auto}
h2{font-size:1.2rem;margin:1.8rem 0 0.6rem;padding-bottom:0.3rem;border-bottom:2px solid var(--border)}
h3{font-size:0.95rem;margin:1rem 0 0.3rem;color:var(--muted)}
.badge{display:inline-block;padding:0.15em 0.6em;border-radius:6px;
  font-weight:700;font-size:0.8rem;color:white;vertical-align:middle}
.b-STRONG{background:var(--strong)}.b-GO{background:var(--go)}
.b-MAYBE{background:var(--maybe);color:#422006}
.b-UNLIKELY{background:var(--unlikely)}.b-NOGO{background:var(--nogo)}
.b-NODATA{background:#94a3b8}.b-ERROR{background:#6b7280}
table{width:100%;border-collapse:collapse;font-size:0.85rem;margin:0.5rem 0 1rem}
th{background:var(--border);padding:0.45rem 0.5rem;text-align:left;font-weight:600;
  position:sticky;top:0;white-space:nowrap}
td{padding:0.4rem 0.5rem;border-bottom:1px solid var(--border);white-space:nowrap}
tr:hover td{background:var(--hover)}
.n{text-align:right;font-variant-numeric:tabular-nums}
.na{color:var(--muted)}
.table-wrap{overflow-x:auto}
.sbox{background:var(--card);border-radius:10px;padding:1rem;
  box-shadow:0 1px 3px rgba(0,0,0,.08);margin-bottom:1rem}
details>summary{cursor:pointer;list-style:none;user-select:none}
details>summary::-webkit-details-marker{display:none}
.ref-summary{font-size:0.82rem;color:var(--muted);padding:0.35rem 0;
  display:flex;align-items:center;justify-content:space-between;gap:0.8rem}
.ref-title{display:inline-flex;align-items:center;gap:0.58rem}
.ref-arrow::before{content:'\25be';font-size:0.82rem;color:var(--muted)}
.ref-details[open] .ref-arrow::before{content:'\25b4'}
.src-note{font-size:0.72rem;line-height:1.5;color:var(--muted);margin-top:0.2rem}
.sv{display:inline-block;margin-left:0.28rem;padding:0 0.26rem;border-radius:4px;
  border:1px solid #cbd5e1;background:#f8fafc;color:#475569;font-size:0.62rem;
  line-height:1.35;vertical-align:middle}
.model-pill{display:inline-block;padding:0.12rem 0.42rem;border-radius:999px;
  border:1px solid #bfdbfe;background:#eff6ff;color:#1e3a8a;font-size:0.69rem;font-weight:600}
.metrics{display:grid;grid-template-columns:repeat(auto-fill,minmax(168px,1fr));
  gap:0.55rem;margin-bottom:0.65rem}
.metric{background:#ffffff;border:1px solid var(--border);border-radius:8px;padding:0.45rem 0.6rem}
.ml{font-size:0.69rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.03em}
.mv{font-size:1.05rem;font-weight:600;line-height:1.2;margin-top:0.1rem}
.ms{font-size:0.66rem;color:var(--muted);line-height:1.3;margin-top:0.12rem}
.flags{margin:0.5rem 0}
.fl{padding:0.15rem 0;font-size:0.85rem}
.fw{color:var(--nogo)}.fw::before{content:'⚠ '}
.fg{color:var(--go)}.fg::before{content:'✓ '}
.htbl th{text-align:center;font-size:0.75rem;padding:0.3rem 0.35rem}
.htbl td{text-align:center;font-size:0.8rem;padding:0.25rem 0.35rem}
.tw{background:#f0fdf4}.tw-peak{background:#dcfce7;font-weight:600}
.sum-row{cursor:pointer;transition:background 0.1s}
.sum-row:hover td{background:#e0f2fe !important}
.sum-row.expanded td{background:#f0f9ff}
.arrow{text-align:center;font-size:0.9rem;color:var(--muted);user-select:none;width:2em}
.detail-row>td{padding:0 !important;border-bottom:2px solid var(--border)}
.detail-row .cbody{padding:0.75rem 1rem 1rem;background:var(--hover)}
.detail-row:hover>td{background:transparent !important}
.empty{text-align:center;color:var(--muted);padding:3rem;font-size:1.1rem}
.footer{margin-top:2rem;text-align:center;color:var(--muted);font-size:0.8rem;padding:1rem}
/* Confidence badges */
.conf-HIGH{color:var(--go);font-weight:600}
.conf-MEDIUM{color:var(--maybe);font-weight:600}
.conf-LOW{color:var(--nogo);font-weight:600}
.conf-UNKNOWN{color:var(--muted)}
/* Agreement bar */
.agree-bar{display:inline-block;width:60px;height:8px;background:#e2e8f0;border-radius:4px;
  overflow:hidden;vertical-align:middle;margin-left:4px}
.agree-fill{height:100%;border-radius:4px}
/* Doubts box */
.doubt-box{background:#fef3c7;border:1px solid #fbbf24;border-radius:8px;padding:0.7rem 1rem;margin:1rem 0}
.doubt-box h3{color:#92400e;margin:0 0 0.3rem}
.doubt-box ul{margin:0.2rem 0 0 1.2rem;font-size:0.85rem;color:#78350f}
.no-doubt{background:#ecfdf5;border-color:#6ee7b7;color:#065f46}
.no-doubt h3{color:#065f46}
/* Narrow ensemble columns */
.ens-tbl th.n,.ens-tbl td.n{padding:0.2rem 0.25rem;max-width:50px;font-size:0.72rem}
.ens-tbl th{font-size:0.68rem;padding:0.25rem 0.3rem}
.ens-tbl td:first-child{max-width:120px;overflow:hidden;text-overflow:ellipsis}
/* Ensemble legend (collapsible) */
.ens-legend{font-size:0.76rem;color:var(--muted);line-height:1.5;margin:0.3rem 0}
.ens-legend dt{font-weight:600;color:var(--text)}
.ens-legend dd{margin:0 0 0.25rem 1rem}
/* Per-model tables */
.model-tab-bar{display:flex;gap:0.3rem;margin:0.4rem 0;flex-wrap:wrap}
.model-tab{padding:0.2rem 0.5rem;border:1px solid var(--border);border-radius:4px;
  font-size:0.72rem;cursor:pointer;background:var(--card);color:var(--text)}
.model-tab.active{background:#dbeafe;border-color:#3b82f6;font-weight:600}
.model-panel{display:none}.model-panel.active{display:block}
@media(max-width:768px){
  table{font-size:0.78rem}th,td{padding:0.3rem}
  .hdr h1{font-size:1.1rem}.hdr-inner{gap:0.5rem}
}
/* Compact inner detail tables */
.cbody table:not(.htbl){width:auto;max-width:100%}
.ctbl{font-size:0.78rem;margin:0.3rem 0 0.5rem}
.ctbl th{font-size:0.72rem;padding:0.22rem 0.35rem}
.ctbl td{padding:0.18rem 0.35rem}
.ctbl .model-pill{font-size:0.62rem;padding:0.06rem 0.28rem}
/* Score breakdown */
.score-box{background:#f8fafc;border:1px solid var(--border);border-radius:8px;
  padding:0.5rem 0.7rem;margin:0.5rem 0;font-size:0.8rem;line-height:1.7}
.sb-line{display:flex;justify-content:space-between;gap:0.5rem;max-width:340px}
.sb-lbl{color:var(--muted);font-size:0.78rem}
.sb-val{font-weight:600;font-variant-numeric:tabular-nums;min-width:3em;text-align:right}
.sb-total{border-top:2px solid var(--border);margin-top:0.15rem;padding-top:0.15rem;font-weight:700}
.sb-neg{color:var(--nogo)}.sb-pos{color:var(--go)}.sb-zero{color:var(--muted)}
</style>
</head>
<body>
<div class="hdr">
  <div class="hdr-inner">
    <h1>✈️ PG Weather Triage</h1>
    <select id="ds"></select>
    <div class="meta" id="hdr-meta"></div>
  </div>
</div>
<div class="wrap">
  <div id="m"></div>
  <div class="footer">PG Weather Triage v2.0</div>
</div>
<script>
const R = __REPORTS_DATA__;
const SO = {STRONG:0,GO:1,MAYBE:2,UNLIKELY:3,'NO-GO':4,'NO DATA':5,ERROR:6};
function esc(t){if(t==null)return'';return String(t).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
function fmt(v,u,p){
  if(v==null)return'<span class="na">\u2014</span>';
  if(typeof v==='number'){p=p!=null?p:1;return v.toFixed(p)+(u||'')}
  return String(v)+(u||'');
}
function badge(s){return'<span class="badge b-'+((s||'ERROR').replace(/-/g,'').replace(/ /g,''))+'">'+esc(s)+'</span>'}
function hasV(v){return v!==null&&v!==undefined}

const MODEL_META={
  ecmwf_hres:{name:'ECMWF IFS HRES',step:'0.25°',short:'ECM',api:'ecmwf_ifs025'},
  ecmwf_ifs025:{name:'ECMWF IFS',step:'0.25°',short:'EC25',api:'ecmwf_ifs025'},
  ecmwf_ifs04:{name:'ECMWF IFS',step:'0.4°',short:'EC04',api:'ecmwf_ifs04'},
  icon_seamless:{name:'ICON Seamless',step:'blend',short:'ICN',api:'icon_seamless'},
  icon_d2:{name:'ICON-D2',step:'2 km',short:'I2',api:'icon_d2'},
  icon_eu:{name:'ICON-EU',step:'7 km',short:'IEU',api:'icon_eu'},
  icon_global:{name:'ICON Global',step:'13 km',short:'IG',api:'icon_global'},
  gfs:{name:'GFS',step:'~0.25°',short:'GFS',api:'gfs_seamless'},
  gfs_seamless:{name:'GFS Seamless',step:'blend',short:'GFS',api:'gfs_seamless'},
  ecmwf_ens:{name:'ECMWF ENS',step:'51 mem',short:'E-ens',api:'ecmwf_ifs025'},
  icon_eu_eps:{name:'ICON-EU EPS',step:'40 mem',short:'I-eps',api:'icon_eu'},
  geosphere_arome:{name:'GeoSphere AROME',step:'2.5 km',short:'GEO',api:'arpege_seamless_2.5km'},
  mosmix:{name:'DWD MOSMIX',step:'station',short:'MOS',api:'mosmix_l'},
};
const MOSMIX_PARAM_HELP={
  TTT:'Температура, °C',Td:'Точка росы, °C',
  FF:'Ветер 10 м, m/s',FX1:'Порыв за 1 час, m/s',DD:'Направление ветра, °',
  N:'Облачность, %',Neff:'Эффективная облачность, %',
  Nh:'Высокая обл., %',Nm:'Средняя обл., %',Nl:'Низкая обл., %',
  PPPP:'Давление MSL, hPa',SunD1:'Солнце за 1 час, s',Rad1h:'Радиация за 1 час, kJ/m²',
  RR1c:'Осадки за 1 час, mm',wwP:'Вероятность явления, %',R101:'Вероятность осадков >0.1 mm, %',
};

/* Source priority for best value */
const SRC_PRIORITY=['icon_d2','icon_eu','icon_global','ecmwf_ifs025','ecmwf_ifs04','ecmwf_hres','gfs_seamless','gfs','icon_seamless'];
function bestAt13(r,key){
  var s=r.sources||{};
  for(var i=0;i<SRC_PRIORITY.length;i++){
    var src=s[SRC_PRIORITY[i]];
    if(!src)continue;
    var a13=src.at_13_local||src.at_13||{};
    if(hasV(a13[key]))return{val:a13[key],src:SRC_PRIORITY[i]};
  }
  return{val:null,src:null};
}
function modelShort(id){var m=MODEL_META[id];return m?m.short:(id||'\u2014')}
function modelName(id){var m=MODEL_META[id];return m?m.name+' ['+m.step+'] ('+m.api+')':(id||'\u2014')}
function fmtSrc(v,u,p,srcId){
  var out=fmt(v,u,p);
  if(!hasV(v)||!srcId)return out;
  return out+'<span class="sv" title="'+esc(modelName(srcId))+'">'+esc(modelShort(srcId))+'</span>';
}
function confClass(c){return'conf-'+(c||'UNKNOWN')}
function agreeBar(score){
  if(score==null)return'';
  var pct=Math.round(score*100);
  var color=pct>=80?'var(--go)':pct>=50?'var(--maybe)':'var(--nogo)';
  return ' <span class="agree-bar"><span class="agree-fill" style="width:'+pct+'%;background:'+color+'"></span></span> '+pct+'%';
}
/* Value coloring based on flyability thresholds */
function valColor(field,val,peaks){
  if(val==null)return'';
  switch(field){
  case'wind_850':return val>5?'var(--nogo)':val>3.5?'var(--unlikely)':'';
  case'gusts':return val>10?'var(--nogo)':val>7?'var(--unlikely)':'';
  case'gust_factor':return val>7?'var(--nogo)':val>4?'var(--unlikely)':'';
  case'wind_10m':return val>8?'var(--nogo)':val>5?'var(--unlikely)':'';
  case'precipitation':return val>0.5?'var(--nogo)':val>0.1?'var(--unlikely)':'';
  case'cloudcover':return val>80?'var(--nogo)':val>60?'var(--unlikely)':val<30?'var(--go)':'';
  case'lapse_rate':return val<5.5?'var(--unlikely)':val>7?'var(--go)':'';
  case'cape':return val>1500?'var(--nogo)':(val>=300&&val<=1500)?'var(--go)':'';
  case'cloudbase_msl':return val<1000?'var(--nogo)':val>3500?'var(--go)':'';
  case'wstar':return val>=1.5?'var(--go)':val>=1.0?'#059669':'';
  case'lifted_index':return val<-4?'var(--nogo)':'';
  case'bl_height':return val>1500?'var(--go)':'';
  case'shortwave_radiation':return val>600?'var(--go)':'';
  }return'';
}
function fmtC(v,u,p,field,peaks){
  var txt=fmt(v,u,p);
  if(v==null)return txt;
  var c=valColor(field,v,peaks);
  if(c)return'<span style="color:'+c+'">'+txt+'</span>';
  return txt;
}

const ANALYSIS_HOURS=['08:00','09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00','18:00'];

/* ── Main render ── */
function render(date){
  var d=R[date];if(!d){document.getElementById('m').innerHTML='<div class="empty">No data</div>';return}
  var forecastDate=d.forecast_date||d.date||date;
  var stack=d.model_stack||{};
  var allModels=[].concat(stack.deterministic||[],stack.ensemble||[],stack.regional||[]);
  document.getElementById('hdr-meta').textContent=
    'Forecast: '+forecastDate+' \u00b7 Generated: '+(d.generated_at||'')+' \u00b7 v'+(d.app_version||'?');

  var locs=(d.locations||[]).slice().sort(function(a,b){
    var sa=(a.assessment||{}).status||'ERROR',sb=(b.assessment||{}).status||'ERROR';
    return (SO[sa]||5)-(SO[sb]||5);
  });
  var h='<h2>\ud83d\udcc5 Forecast for: '+esc(forecastDate)+'</h2>';
  h+=renderRef();
  h+=renderMainTable(locs);
  document.getElementById('m').innerHTML=h;
  document.querySelectorAll('.sum-row').forEach(function(row){
    row.addEventListener('click',function(){
      var key=this.dataset.key;
      var det=document.getElementById('det-'+key);
      var arrow=this.querySelector('.arrow');
      if(!det)return;
      if(det.style.display==='none'){
        det.style.display='';arrow.textContent='\u25b4';this.classList.add('expanded');
      }else{
        det.style.display='none';arrow.textContent='\u25be';this.classList.remove('expanded');
      }
    });
  });
}

function renderRef(){
  var h='<div class="sbox" style="margin-bottom:0.75rem">';
  h+='<details class="ref-details"><summary class="ref-summary">';
  h+='<span class="ref-title"><span>\u2139\ufe0f</span><span>Parameter Reference &amp; Score</span></span>';
  h+='<span class="ref-arrow" aria-hidden="true"></span></summary>';
  h+='<div style="font-size:0.75rem;color:var(--muted);margin:0.5rem 0 0;line-height:1.8">';
  h+='<b>Score v2.0</b> \u2014 base from thermal window hours, then: critical \u00d7(\u22123), LOW_BASE \u00d7(\u22122), quality/danger \u00d7(\u22121), positive \u00d7(+1), VERY_HIGH_BASE \u00d7(+2). ';
  h+='Thresholds: \u2264\u22125 NO\u2011GO, \u2264\u22122 UNLIKELY, \u22641 MAYBE, \u22644 GO, \u22655 STRONG.<br>';
  h+='<b>Thermal window</b> \u2014 hours with W*\u22651.0, precip\u22640.5, base\u22651000m MSL, cloud<60%. ';
  h+='Base score: 0h=\u22126, 1\u20132h=\u22122, 3\u20134h=+1, 5\u20136h=+4, 7+h=+6.<br>';
  h+='<b>Base</b> \u2014 cloudbase MSL (m) from T\u2212Td. <b>CB min/typ</b> \u2014 min/median base over 09\u201318 window.<br>';
  h+='<b>W850 mean</b> \u2014 sustained wind 850 hPa mean over window. >5 m/s = closed route risk.<br>';
  h+='<b>Gusts max</b> \u2014 max gust over window. <b>GF max</b> \u2014 max gust factor (gust\u2212mean).<br>';
  h+='<b>Flyable</b> \u2014 longest continuous window with no precip, gusts\u226412, wind\u22648.<br>';
  h+='<b>CAPE</b> \u2014 J/kg. >300 thermals, >700 strong, >1500 storm risk.<br>';
  h+='<b>Lapse</b> \u2014 850\u2192700 hPa \u00b0C/km. >7 strong, <5.5 weak.<br>';
  h+='<b>BL</b> \u2014 Boundary Layer height (m). <b>W*</b> \u2014 Deardorff thermal strength (m/s).<br>';
  h+='<b>Confidence</b> \u2014 model agreement ECMWF vs ICON. HIGH\u226580%, MEDIUM\u226550%, LOW<50%.';
  h+='</div></details></div>';
  return h;
}

function renderMainTable(locs){
  var NC=19;
  var h='<div class="sbox"><div class="table-wrap"><table>';
  h+='<thead><tr>';
  h+='<th style="width:2em"></th>';
  h+='<th>Location</th><th>Drive</th><th>Status</th><th class="n">Score</th>';
  h+='<th class="n">Base</th><th class="n">Margin</th>';
  h+='<th class="n">CB min</th><th class="n">CB typ</th>';
  h+='<th class="n">W850 m</th><th class="n">Gust mx</th><th class="n">GF mx</th>';
  h+='<th class="n">CAPE</th><th class="n">Lapse</th>';
  h+='<th class="n">BL</th><th class="n">W*</th>';
  h+='<th class="n">Cloud</th><th>Thermal</th><th>Confidence</th>';
  h+='</tr></thead>';
  locs.forEach(function(r){
    var a=r.assessment||{};
    var twh=a.thermal_window_hours||0;
    var twStr=twh>0?twh+'h ('+(a.thermal_window_start||'')+'\u2013'+(a.thermal_window_end||'')+')':'\u2014';
    var ma=a.model_agreement||{};
    var conf=ma.confidence||'?';
    var ascore=ma.agreement_score;
    /* Source provenance from _sources dict */
    var _srcs=(a._sources||{});
    function srcOf(field){return _srcs[field]||null}
    h+='<tr class="sum-row" data-key="'+(r.key||'')+'">';
    h+='<td class="arrow">\u25be</td>';
    h+='<td><strong>'+esc(r.location)+'</strong></td>';
    h+='<td>'+fmt(r.drive_h,'h')+'</td>';
    h+='<td>'+badge(a.status)+'</td>';
    h+='<td class="n">'+(a.score!=null?a.score:'\u2014')+'</td>';
    h+='<td class="n">'+fmtSrc(a.cloudbase_msl,'',0,srcOf('temp_2m'))+'</td>';
    h+='<td class="n">'+fmt(a.base_margin_over_peaks,'',0)+'</td>';
    h+='<td class="n">'+fmt(a.cb_min_msl,'',0)+'</td>';
    h+='<td class="n">'+fmt(a.cb_typ_msl,'',0)+'</td>';
    h+='<td class="n">'+fmtSrc(a.sustained_wind_850_mean,'',1,srcOf('wind_850hPa_ms'))+'</td>';
    h+='<td class="n">'+fmtSrc(a.max_gust_window,'',1,srcOf('gusts_10m_ms'))+'</td>';
    h+='<td class="n">'+fmt(a.max_gust_factor_window,'',1)+'</td>';
    h+='<td class="n">'+fmtSrc(a.cape_J_per_kg,'',0,srcOf('cape_J_per_kg'))+'</td>';
    h+='<td class="n">'+fmtSrc(a.lapse_rate_C_per_km,'',1,srcOf('t850'))+'</td>';
    h+='<td class="n">'+fmtSrc(a.boundary_layer_height_m,'',0,srcOf('boundary_layer_height_m'))+'</td>';
    h+='<td class="n">'+fmt(a.wstar_ms,'',2)+'</td>';
    h+='<td class="n">'+fmtSrc(a.cloudcover_pct,'%',0,srcOf('cloudcover_pct'))+'</td>';
    h+='<td>'+twStr+'</td>';
    h+='<td><span class="'+confClass(conf)+'">'+esc(conf)+'</span>'+agreeBar(ascore)+'</td>';
    h+='</tr>';
    h+='<tr id="det-'+(r.key||'')+'" class="detail-row" style="display:none">';
    h+='<td colspan="'+NC+'"><div class="cbody">';
    h+=renderCardBody(r);
    h+='</div></td></tr>';
  });
  h+='</table></div>';
  h+='<div class="src-note">Маркер рядом со значением показывает модель-источник. Приоритет: ICON-D2 → ECMWF → ICON → GFS.</div>';
  var pills=Object.keys(MODEL_META).map(function(id){
    var m=MODEL_META[id];
    return'<span class="model-pill">'+esc(m.short)+': '+esc(m.name)+' ('+esc(m.api)+')</span>';
  }).join(' ');
  h+='<div style="margin-top:0.3rem">'+pills+'</div>';
  h+='</div>';
  return h;
}

function renderCardBody(r){
  var a=r.assessment||{};
  if(r.error&&!a.status)return'<p style="color:var(--nogo)">Error: '+esc(r.error)+'</p>';
  var h='';
  var peaks=r.peaks||null;

  /* Metrics grid */
  var twh=a.thermal_window_hours||0;
  var tw=twh>0?(a.thermal_window_start+'\u2013'+a.thermal_window_end+' ('+twh+'h)'):'\u2014';
  var cfw=a.continuous_flyable_hours||0;
  var fw=cfw>0?cfw+'h ('+(a.flyable_start||'')+'\u2013'+(a.flyable_end||'')+')':'\u2014';
  var _srcs=(a._sources||{});
  function srcTag(f){var s=_srcs[f];return s?'<span class="sv" title="'+esc(modelName(s))+'">'+esc(modelShort(s))+'</span>':''}
  var metrics=[
    ['Base MSL @13',fmt(a.cloudbase_msl,'m',0)+srcTag('temp_2m'),''],
    ['Margin',fmt(a.base_margin_over_peaks,'m',0),''],
    ['CB min / typ',fmt(a.cb_min_msl,'',0)+' / '+fmt(a.cb_typ_msl,'',0),'over window'],
    ['W850 mean',fmt(a.sustained_wind_850_mean,' m/s',1)+srcTag('wind_850hPa_ms'),'window mean'],
    ['W850 @13',fmt(a.wind_850hPa_ms,' m/s',1)+srcTag('wind_850hPa_ms'),''],
    ['W700 @13',fmt(a.wind_700hPa_ms,' m/s',1)+srcTag('wind_700hPa_ms'),''],
    ['Gusts @13',fmt(a.gusts_10m_ms,' m/s',1)+srcTag('gusts_10m_ms'),''],
    ['Gusts max win',fmt(a.max_gust_window,' m/s',1),''],
    ['GF max',fmt(a.max_gust_factor_window,' m/s',1),'gust\u2212mean'],
    ['CAPE',fmt(a.cape_J_per_kg,' J/kg',0)+srcTag('cape_J_per_kg'),''],
    ['LI',fmt(a.lifted_index,'',1)+srcTag('lifted_index'),''],
    ['CIN',fmt(a.cin_J_per_kg,' J/kg',0)+srcTag('cin_J_per_kg'),''],
    ['Lapse',fmt(a.lapse_rate_C_per_km,' \u00b0C/km',1)+srcTag('t850'),'850\u2192700'],
    ['BL height',fmt(a.boundary_layer_height_m,'m',0)+srcTag('boundary_layer_height_m'),''],
    ['W*',fmt(a.wstar_ms,' m/s',2),''],
    ['Cloud',fmt(a.cloudcover_pct,'%',0)+srcTag('cloudcover_pct'),''],
    ['CL/CM/CH',fmt(a.cloudcover_low_pct,'',0)+'/'+fmt(a.cloudcover_mid_pct,'',0)+'/'+fmt(a.cloudcover_high_pct,'',0),'low/mid/high'],
    ['Precip',fmt(a.precipitation_mm,' mm',1)+srcTag('precipitation_mm'),''],
    ['SW rad',fmt(a.shortwave_radiation,' W/m\u00b2',0)+srcTag('shortwave_radiation'),''],
    ['RH 2m/850/700',fmt(a.relative_humidity_2m,'',0)+'/'+fmt(a.relative_humidity_850,'',0)+'/'+fmt(a.relative_humidity_700,'',0),'%'],
    ['Flyable window',fw,'continuous'],
    ['Thermal window',tw,'W*-based'],
  ];
  h+='<div class="metrics">';
  metrics.forEach(function(m){
    h+='<div class="metric"><div class="ml">'+esc(m[0])+'</div><div class="mv">'+m[1]+'</div>';
    if(m[2])h+='<div class="ms">'+esc(m[2])+'</div>';
    h+='</div>';
  });
  h+='</div>';

  /* Flags */
  var flags=a.flags||[],pos=a.positives||[];
  if(flags.length||pos.length){
    h+='<div class="flags">';
    flags.forEach(function(f){h+='<div class="fl fw"><strong>'+esc(f.tag)+'</strong>: '+esc(f.msg)+'</div>'});
    pos.forEach(function(p){h+='<div class="fl fg"><strong>'+esc(p.tag)+'</strong>: '+esc(p.msg)+'</div>'});
    h+='</div>';
  }

  /* Score Breakdown */
  var sb=a.score_breakdown||{};
  if(sb.base_score!=null){
    var twh=sb.tw_hours||0;
    var bs=sb.base_score;
    var nc=sb.n_critical||0,nb=sb.n_low_base||0,nq=sb.n_quality||0,nd=sb.n_danger||0,np=sb.n_positive||0;
    var nvhb=sb.n_very_high_base||0;
    function sbCls(v){return v>0?'sb-pos':v<0?'sb-neg':'sb-zero'}
    function sbFmt(v){return(v>0?'+':'')+v}
    h+='<h3>Score Breakdown</h3>';
    h+='<div class="score-box">';
    h+='<div class="sb-line"><span class="sb-lbl">Thermal window: '+twh+'h \u2192 base</span><span class="sb-val '+sbCls(bs)+'">'+sbFmt(bs)+'</span></div>';
    if(nc)h+='<div class="sb-line"><span class="sb-lbl">Critical flags: '+nc+' \u00d7 (\u22123)</span><span class="sb-val sb-neg">\u2212'+(nc*3)+'</span></div>';
    if(nb)h+='<div class="sb-line"><span class="sb-lbl">Low base: '+nb+' \u00d7 (\u22122)</span><span class="sb-val sb-neg">\u2212'+(nb*2)+'</span></div>';
    if(nq)h+='<div class="sb-line"><span class="sb-lbl">Quality flags: '+nq+' \u00d7 (\u22121)</span><span class="sb-val sb-neg">\u2212'+nq+'</span></div>';
    if(nd)h+='<div class="sb-line"><span class="sb-lbl">Danger flags: '+nd+' \u00d7 (\u22121)</span><span class="sb-val sb-neg">\u2212'+nd+'</span></div>';
    if(np)h+='<div class="sb-line"><span class="sb-lbl">Positives: '+np+' \u00d7 (+1)</span><span class="sb-val sb-pos">+'+np+'</span></div>';
    if(nvhb)h+='<div class="sb-line"><span class="sb-lbl">Very high base: '+nvhb+' \u00d7 (+2)</span><span class="sb-val sb-pos">+'+(nvhb*2)+'</span></div>';
    h+='<div class="sb-line sb-total"><span>Total score</span><span class="sb-val">'+(a.score!=null?a.score:'\u2014')+' \u2192 '+badge(a.status)+'</span></div>';
    h+='</div>';
  }

  /* Model Agreement */
  var ma=a.model_agreement||{};
  if(ma.agreement_score!=null){
    var det=ma.details||{};
    h+='<h3>Model Agreement: <span class="'+confClass(ma.confidence)+'">'+esc(ma.confidence)+'</span>'+agreeBar(ma.agreement_score)+'</h3>';
    if(Object.keys(det).length){
      h+='<div class="table-wrap"><table class="ctbl">';
      h+='<tr><th>Param</th><th class="n">ECMWF</th><th class="n">ICON</th><th class="n">Diff</th><th>Agree</th></tr>';
      Object.keys(det).forEach(function(p){
        var d=det[p];
        h+='<tr><td>'+esc(p)+'</td><td class="n">'+fmt(d.ecmwf)+'</td><td class="n">'+fmt(d.icon)+'</td>';
        h+='<td class="n">'+fmt(d.diff)+'</td><td>'+(d.agree?'\u2713':'\u2717')+'</td></tr>';
      });
      h+='</table></div>';
    }
  }

  /* Ensemble Uncertainty */
  var eu=a.ensemble_uncertainty||{};
  var euKeys=Object.keys(eu);
  if(euKeys.length){
    h+='<h3>Ensemble Spread</h3>';
    euKeys.forEach(function(ens){
      var ed=eu[ens];
      h+='<div style="margin-bottom:0.5rem"><span class="model-pill">'+esc(modelShort(ens)+': '+modelName(ens))+'</span></div>';
      h+='<div class="table-wrap"><table class="ctbl ens-tbl">';
      h+='<tr><th>Param</th><th class="n">p10</th><th class="n">p50</th><th class="n">p90</th><th class="n">Spread</th></tr>';
      Object.keys(ed).forEach(function(p){
        var pd=ed[p];
        h+='<tr><td>'+esc(p)+'</td><td class="n">'+fmt(pd.p10)+'</td><td class="n">'+fmt(pd.p50)+'</td>';
        h+='<td class="n">'+fmt(pd.p90)+'</td><td class="n">'+fmt(pd.spread)+'</td></tr>';
      });
      h+='</table></div>';
    });
    /* Collapsible ensemble legend */
    h+='<details class="ref-details" style="margin-top:0.3rem"><summary class="ref-summary">';
    h+='<span class="ref-title"><span>\u2139\ufe0f</span><span>Ensemble parameters legend</span></span>';
    h+='<span class="ref-arrow"></span></summary>';
    h+='<dl class="ens-legend">';
    h+='<dt>p10</dt><dd>10th percentile \u2014 optimistic bound (90% of members predict worse)</dd>';
    h+='<dt>p50</dt><dd>50th percentile (median) \u2014 central estimate</dd>';
    h+='<dt>p90</dt><dd>90th percentile \u2014 pessimistic bound (only 10% of members predict worse)</dd>';
    h+='<dt>Spread</dt><dd>p90 \u2212 p10 \u2014 ensemble uncertainty. High spread = low confidence.</dd>';
    h+='<dt>temperature_2m</dt><dd>2m temperature (\u00b0C)</dd>';
    h+='<dt>windspeed_10m</dt><dd>10m wind speed (m/s). Spread >4 = significant uncertainty.</dd>';
    h+='<dt>windgusts_10m</dt><dd>Wind gusts at 10m (m/s)</dd>';
    h+='<dt>cloudcover</dt><dd>Total cloud cover (%). Spread >40 = uncertain sky.</dd>';
    h+='<dt>precipitation</dt><dd>Precipitation (mm/h)</dd>';
    h+='<dt>cape</dt><dd>CAPE (J/kg). Spread >600 = convective uncertainty.</dd>';
    h+='<dt>windspeed_850hPa</dt><dd>Wind at 850 hPa (~1500m, gradient wind)</dd>';
    h+='</dl></details>';
  }

  /* Per-model assessment summary */
  var pma=a.per_model_assessment||{};
  var pmaKeys=Object.keys(pma);
  if(pmaKeys.length>1){
    h+='<h3>Per-Model Assessment</h3>';
    h+='<div class="table-wrap"><table class="ctbl">';
    h+='<tr><th>Model</th><th class="n">Thermal h</th><th class="n">Flyable h</th><th>Status</th></tr>';
    pmaKeys.forEach(function(mk){
      var md=pma[mk];
      h+='<tr><td><span class="model-pill">'+esc(modelShort(mk)+': '+(md.model_label||mk))+'</span></td>';
      h+='<td class="n">'+fmt(md.thermal_hours)+'</td>';
      h+='<td class="n">'+fmt(md.flyable_hours)+'</td>';
      h+='<td>'+badge(md.status)+'</td></tr>';
    });
    h+='</table></div>';
  }

  /* Hourly profile */
  var hp=(r.hourly_analysis||{}).hourly_profile||[];
  if(hp.length){
    h+='<h3>Hourly Profile (08:00\u201318:00 local)</h3>';
    h+='<div class="table-wrap"><table class="htbl">';
    h+='<tr><th>Hour</th><th>Src</th><th>T</th><th>Dew</th><th>Base</th><th>Cloud</th><th>CL/CM/CH</th>';
    h+='<th>Prcp</th><th>W10</th><th>Gust</th><th>GF</th><th>W850</th><th>W700</th>';
    h+='<th>RH850</th><th>RH700</th><th>Lapse</th><th>BL</th><th>CAPE</th><th>SW</th><th>W*</th></tr>';
    var tws=a.thermal_window_start,twe=a.thermal_window_end,twp=a.thermal_window_peak;
    var twsI=tws?parseInt(tws):99,tweI=twe?parseInt(twe):-1;
    hp.forEach(function(item){
      var hrI=parseInt(item.hour);
      var cls='';
      if(hrI>=twsI&&hrI<=tweI){cls=item.hour===twp?' class="tw-peak"':' class="tw"'}
      h+='<tr'+cls+'>';
      h+='<td><strong>'+item.hour+'</strong></td>';
      var srcShort=modelShort(item._src);
      var srcTitle=modelName(item._src);
      var ovr=item._src_overrides;
      if(ovr){var ovrKeys=Object.keys(ovr);srcTitle+=' (+'+ovrKeys.map(function(k){return k+':'+modelShort(ovr[k])}).join(', ')+')';srcShort+='+'}
      h+='<td><span class="sv" title="'+esc(srcTitle)+'">'+esc(srcShort)+'</span></td>';
      h+='<td>'+fmt(item.temp_2m,'',1)+'</td>';
      h+='<td>'+fmt(item.dewpoint,'',1)+'</td>';
      h+='<td>'+fmtC(item.cloudbase_msl,'',0,'cloudbase_msl',peaks)+'</td>';
      h+='<td>'+fmtC(item.cloudcover,'',0,'cloudcover')+'</td>';
      var cl=fmt(item.cloudcover_low,'',0)+'/'+fmt(item.cloudcover_mid,'',0)+'/'+fmt(item.cloudcover_high,'',0);
      h+='<td>'+cl+'</td>';
      h+='<td>'+fmtC(item.precipitation,'',1,'precipitation')+'</td>';
      h+='<td>'+fmtC(item.wind_10m,'',1,'wind_10m')+'</td>';
      h+='<td>'+fmtC(item.gusts,'',1,'gusts')+'</td>';
      h+='<td>'+fmtC(item.gust_factor,'',1,'gust_factor')+'</td>';
      h+='<td>'+fmtC(item.wind_850,'',1,'wind_850')+'</td>';
      h+='<td>'+fmt(item.wind_700,'',1)+'</td>';
      h+='<td>'+fmt(item.rh_850,'',0)+'</td>';
      h+='<td>'+fmt(item.rh_700,'',0)+'</td>';
      h+='<td>'+fmtC(item.lapse_rate,'',1,'lapse_rate')+'</td>';
      h+='<td>'+fmtC(item.bl_height,'',0,'bl_height')+'</td>';
      h+='<td>'+fmtC(item.cape,'',0,'cape')+'</td>';
      h+='<td>'+fmtC(item.shortwave_radiation,'',0,'shortwave_radiation')+'</td>';
      h+='<td>'+fmtC(item.wstar,'',2,'wstar')+'</td>';
      h+='</tr>';
    });
    h+='</table></div>';
  }

  /* Per-model hourly tables (tabbed) */
  var mps=(r.hourly_analysis||{}).model_profiles||{};
  var mpKeys=Object.keys(mps);
  if(mpKeys.length>1){
    var mpId='mp_'+Math.random().toString(36).substr(2,6);
    h+='<h3>Per-Model Hourly (08:00\u201318:00)</h3>';
    h+='<div class="model-tab-bar">';
    mpKeys.forEach(function(mk,idx){
      h+='<div class="model-tab'+(idx===0?' active':'')+'" onclick="(function(el){';
      h+='var p=el.parentNode.parentNode;';
      h+='p.querySelectorAll(\'.model-tab\').forEach(function(t){t.classList.remove(\'active\')});';
      h+='el.classList.add(\'active\');';
      h+='p.querySelectorAll(\'.model-panel\').forEach(function(t){t.classList.remove(\'active\')});';
      h+='p.querySelector(\'[data-model=\\\'\'+el.dataset.model+\'\\\']\').classList.add(\'active\');';
      h+='})(this)" data-model="'+esc(mk)+'">'+esc(modelShort(mk)+': '+(MODEL_META[mk]?MODEL_META[mk].name:mk))+'</div>';
    });
    h+='</div>';
    mpKeys.forEach(function(mk,idx){
      var mp=mps[mk];
      h+='<div class="model-panel'+(idx===0?' active':'')+'" data-model="'+esc(mk)+'">';
      h+='<div class="table-wrap"><table class="htbl">';
      h+='<tr><th>Hour</th><th>T</th><th>Base</th><th>Cloud</th>';
      h+='<th>Prcp</th><th>W10</th><th>Gust</th><th>W850</th>';
      h+='<th>Lapse</th><th>BL</th><th>CAPE</th><th>SW</th><th>W*</th></tr>';
      mp.forEach(function(item){
        var hrI=parseInt(item.hour);
        var cls='';
        if(item.wstar!=null&&item.wstar>=1.0)cls=' class="tw"';
        h+='<tr'+cls+'>';
        h+='<td><strong>'+item.hour+'</strong></td>';
        h+='<td>'+fmt(item.temp_2m,'',1)+'</td>';
        h+='<td>'+fmtC(item.cloudbase_msl,'',0,'cloudbase_msl',peaks)+'</td>';
        h+='<td>'+fmtC(item.cloudcover,'',0,'cloudcover')+'</td>';
        h+='<td>'+fmtC(item.precipitation,'',1,'precipitation')+'</td>';
        h+='<td>'+fmtC(item.wind_10m,'',1,'wind_10m')+'</td>';
        h+='<td>'+fmtC(item.gusts,'',1,'gusts')+'</td>';
        h+='<td>'+fmtC(item.wind_850,'',1,'wind_850')+'</td>';
        h+='<td>'+fmtC(item.lapse_rate,'',1,'lapse_rate')+'</td>';
        h+='<td>'+fmtC(item.bl_height,'',0,'bl_height')+'</td>';
        h+='<td>'+fmtC(item.cape,'',0,'cape')+'</td>';
        h+='<td>'+fmtC(item.shortwave_radiation,'',0,'shortwave_radiation')+'</td>';
        h+='<td>'+fmtC(item.wstar,'',2,'wstar')+'</td>';
        h+='</tr>';
      });
      h+='</table></div></div>';
    });
  }

  /* GeoSphere thermal_window_stats */
  var geoTw=(r.sources||{}).geosphere_arome||{};
  var geoStats=geoTw.thermal_window_stats||{};
  if(Object.keys(geoStats).length){
    h+='<h3><span class="model-pill">GEO: GeoSphere AROME 2.5 km</span> \u2014 thermal window stats</h3>';
    h+='<div class="table-wrap"><table class="ctbl">';
    h+='<tr><th>Param</th><th class="n">Min</th><th class="n">Mean</th><th class="n">Max</th><th>Trend</th></tr>';
    var geoParams=['temperature_2m','cape','cloudcover','windspeed_10m','windgusts_10m','shortwave_radiation','precipitation'];
    geoParams.forEach(function(p){
      var s=geoStats[p];
      if(!s||!s.n)return;
      h+='<tr><td>'+esc(p)+'</td><td class="n">'+fmt(s.min)+'</td><td class="n">'+fmt(s.mean)+'</td>';
      h+='<td class="n">'+fmt(s.max)+'</td><td>'+esc(s.trend||'\u2014')+'</td></tr>';
    });
    h+='</table></div>';
  }

  /* MOSMIX data */
  var mosmix=(r.sources||{}).mosmix||{};
  if(mosmix&&!mosmix.error&&mosmix.hourly_local){
    var mh=mosmix.hourly_local;
    var params=Object.keys(mh);
    if(params.length){
      h+='<h3><span class="model-pill">MOS: DWD MOSMIX</span> @ '+esc(mosmix.station_name||'?')+' \u2014 local time</h3>';
      var allH={};params.forEach(function(p){Object.keys(mh[p]).forEach(function(hr){allH[hr]=1})});
      var sortH=Object.keys(allH).sort();
      var targetH=sortH.filter(function(hr){return['09:00','12:00','13:00','15:00','18:00'].indexOf(hr)>=0});
      if(targetH.length){
        h+='<div class="table-wrap"><table class="htbl">';
        h+='<tr><th style="text-align:left">Param</th>'+targetH.map(function(hr){return'<th>'+hr+'</th>'}).join('')+'</tr>';
        params.forEach(function(p){
          h+='<tr><td style="text-align:left"><strong>'+esc(p)+'</strong></td>';
          h+=targetH.map(function(hr){return'<td>'+fmt(mh[p][hr])+'</td>'}).join('');
          h+='</tr>';
        });
        h+='</table></div>';
        /* MOSMIX param agenda */
        h+='<details class="ref-details" style="margin-top:0.3rem"><summary class="ref-summary">';
        h+='<span class="ref-title"><span>\u2139\ufe0f</span><span>MOSMIX params</span></span>';
        h+='<span class="ref-arrow"></span></summary>';
        h+='<div class="table-wrap"><table class="htbl" style="text-align:left">';
        h+='<tr><th style="text-align:left">Param</th><th style="text-align:left">Meaning</th></tr>';
        params.forEach(function(p){
          h+='<tr><td style="text-align:left"><strong>'+esc(p)+'</strong></td>';
          h+='<td style="text-align:left">'+esc(MOSMIX_PARAM_HELP[p]||'see DWD docs')+'</td></tr>';
        });
        h+='</table></div></details>';
      }
    }
  }

  /* Meteo-Parapente */
  var mp=(r.sources||{}).meteo_parapente||{};
  var mpApis=mp.captured_api||[];
  var mpData=null;
  mpApis.forEach(function(a){if(a.type==='json'&&(a.url||'').indexOf('data.php')>=0)mpData=a.data});
  if(mpData&&mpData.data){
    h+='<h3>\ud83c\udfa8 Meteo-Parapente (hi-res thermals)</h3>';
    var mpHours=mpData.data;
    var mpTarget=['09:00','10:00','11:00','12:00','13:00','14:00','15:00','16:00','17:00'];
    var mpAvail=mpTarget.filter(function(hr){return mpHours[hr]});
    if(mpAvail.length){
      h+='<div class="table-wrap"><table class="htbl">';
      h+='<tr><th>Param</th>'+mpAvail.map(function(hr){return'<th>'+hr+'</th>'}).join('')+'</tr>';
      h+='<tr><td><strong>PBL height</strong></td>';
      h+=mpAvail.map(function(hr){return'<td>'+fmt(mpHours[hr].pblh,'m',0)+'</td>'}).join('');
      h+='</tr>';
      ['cfracl','cfracm','cfrach'].forEach(function(p){
        var label={cfracl:'Cloud low%',cfracm:'Cloud mid%',cfrach:'Cloud high%'}[p];
        h+='<tr><td><strong>'+label+'</strong></td>';
        h+=mpAvail.map(function(hr){return'<td>'+fmt(mpHours[hr][p],'%',0)+'</td>'}).join('');
        h+='</tr>';
      });
      h+='<tr><td><strong>Rain mm</strong></td>';
      h+=mpAvail.map(function(hr){return'<td>'+fmt(mpHours[hr].raintot,'',1)+'</td>'}).join('');
      h+='</tr>';
      h+='<tr><td><strong>Max thermal m/s</strong></td>';
      h+=mpAvail.map(function(hr){
        var ths=mpHours[hr].ths||[];var mx=0;ths.forEach(function(v){if(v>mx)mx=v});
        return'<td'+(mx>=0.5?' style="color:var(--go);font-weight:600"':'')+'>'+mx.toFixed(2)+'</td>';
      }).join('');
      h+='</tr>';
      h+='<tr><td><strong>Thermal top m</strong></td>';
      h+=mpAvail.map(function(hr){
        var ths=mpHours[hr].ths||[];var z=mpHours[hr].z||[];var top=0;
        for(var i=0;i<ths.length;i++){if(ths[i]>0.05)top=z[i]}
        return'<td>'+fmt(top,'',0)+'</td>';
      }).join('');
      h+='</tr>';
      h+='</table></div>';
    }
  }

  /* XContest flights */
  var xc=(r.sources||{}).xccontest||{};
  if(xc.flight_count>0){
    h+='<h3>\u2708\ufe0f XContest: '+xc.flight_count+' flights nearby</h3>';
    var xfl=xc.flights_near||[];
    if(xfl.length){
      h+='<table><tr><th>Pilot</th><th>Launch</th><th>Distance</th><th>Type</th></tr>';
      xfl.slice(0,10).forEach(function(fl){
        h+='<tr><td>'+esc(fl.pilot)+'</td><td>'+esc(fl.launch)+'</td>';
        h+='<td>'+esc(fl.distance)+'</td><td>'+esc(fl.type)+'</td></tr>';
      });
      h+='</table>';
    }
  }else if(xc.source==='xccontest'){
    h+='<h3>\u2708\ufe0f XContest: no flights nearby</h3>';
  }

  /* ALPTHERM */
  var alp=(r.sources||{}).alptherm||{};
  if(alp.source==='alptherm'){
    h+='<h3>\ud83c\udfd4\ufe0f ALPTHERM overview</h3>';
    if(alp.error){h+='<div class="src-note">'+esc(alp.error)+'</div>';}
    else{
      var alpRows=alp.tables||[];var alpImgs=alp.thermal_images||[];
      h+='<div class="src-note">Rows: '+alpRows.length+'; images: '+alpImgs.length+'</div>';
      if(alpImgs.length){
        h+='<div class="src-note">'+alpImgs.slice(0,3).map(function(u){
          return'<a href="'+esc(u)+'" target="_blank">'+esc(u)+'</a>';
        }).join(' | ')+'</div>';
      }
      if(alpRows.length){
        h+='<div class="table-wrap"><table class="htbl">';
        h+='<tr><th>col0</th><th>col1</th><th>col2</th><th>col3</th></tr>';
        alpRows.slice(0,8).forEach(function(row){
          h+='<tr><td>'+esc(row.col0||'')+'</td><td>'+esc(row.col1||'')+'</td>';
          h+='<td>'+esc(row.col2||'')+'</td><td>'+esc(row.col3||'')+'</td></tr>';
        });
        h+='</table></div>';
      }
    }
  }

  /* Per-location doubts/uncertainties */
  h+=renderLocDoubts(r);

  return h;
}

/* ── Per-location doubts ── */
function renderLocDoubts(r){
  var a=r.assessment||{};var ma=a.model_agreement||{};var eu=a.ensemble_uncertainty||{};
  var locIssues=[];
  if(ma.confidence==='LOW'){
    locIssues.push('Model agreement LOW ('+Math.round((ma.agreement_score||0)*100)+'%)');
    var det=ma.details||{};
    Object.keys(det).forEach(function(p){
      if(!det[p].agree)locIssues.push('  \u2022 '+p+': ECMWF='+fmt(det[p].ecmwf)+' vs ICON='+fmt(det[p].icon));
    });
  }
  Object.keys(eu).forEach(function(ens){
    var ed=eu[ens];
    Object.keys(ed).forEach(function(p){
      var sp=ed[p].spread;
      if(sp!=null&&((p==='windspeed_10m'&&sp>4)||(p==='cape'&&sp>600)||(p==='cloudcover'&&sp>40)))
        locIssues.push(modelShort(ens)+': high spread in '+p+' (\u00b1'+sp.toFixed(1)+')');
    });
  });
  if(!locIssues.length){
    return'<div class="doubt-box no-doubt" style="margin-top:0.8rem"><h3>\u2705 \u0421\u043e\u043c\u043d\u0435\u043d\u0438\u044f</h3><p style="font-size:0.85rem">\u0417\u043d\u0430\u0447\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0445 \u0440\u0430\u0441\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u0439 \u043d\u0435 \u043e\u0431\u043d\u0430\u0440\u0443\u0436\u0435\u043d\u043e.</p></div>';
  }
  var h='<div class="doubt-box" style="margin-top:0.8rem"><h3>\u26a0\ufe0f \u0421\u043e\u043c\u043d\u0435\u043d\u0438\u044f / \u041d\u0435\u0443\u0432\u0435\u0440\u0435\u043d\u043d\u043e\u0441\u0442\u0438</h3><ul>';
  locIssues.forEach(function(item){h+='<li>'+esc(item)+'</li>'});
  h+='</ul></div>';
  return h;
}

/* ── Doubts/uncertainties block (legacy, unused) ── */
function renderDoubts(locs){
  var issues=[];
  locs.forEach(function(r){
    var a=r.assessment||{};var ma=a.model_agreement||{};var eu=a.ensemble_uncertainty||{};
    var locIssues=[];
    if(ma.confidence==='LOW'){
      locIssues.push('Model agreement LOW ('+Math.round((ma.agreement_score||0)*100)+'%)');
      var det=ma.details||{};
      Object.keys(det).forEach(function(p){
        if(!det[p].agree)locIssues.push('  \u2022 '+p+': ECMWF='+fmt(det[p].ecmwf)+' vs ICON='+fmt(det[p].icon));
      });
    }
    Object.keys(eu).forEach(function(ens){
      var ed=eu[ens];
      Object.keys(ed).forEach(function(p){
        var sp=ed[p].spread;
        if(sp!=null&&((p==='windspeed_10m'&&sp>4)||(p==='cape'&&sp>600)||(p==='cloudcover'&&sp>40)))
          locIssues.push(modelShort(ens)+': high spread in '+p+' (\u00b1'+sp.toFixed(1)+')');
      });
    });
    if(locIssues.length)issues.push({loc:r.location,items:locIssues});
  });
  if(!issues.length){
    return'<div class="doubt-box no-doubt"><h3>\u2705 \u0421\u043e\u043c\u043d\u0435\u043d\u0438\u044f / \u041d\u0435\u0443\u0432\u0435\u0440\u0435\u043d\u043d\u043e\u0441\u0442\u0438</h3><p style="font-size:0.85rem">\u0417\u043d\u0430\u0447\u0438\u0442\u0435\u043b\u044c\u043d\u044b\u0445 \u0440\u0430\u0441\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u0439 \u043d\u0435 \u043e\u0431\u043d\u0430\u0440\u0443\u0436\u0435\u043d\u043e.</p></div>';
  }
  var h='<div class="doubt-box"><h3>\u26a0\ufe0f \u0421\u043e\u043c\u043d\u0435\u043d\u0438\u044f / \u041d\u0435\u0443\u0432\u0435\u0440\u0435\u043d\u043d\u043e\u0441\u0442\u0438 (Model Divergence)</h3>';
  issues.forEach(function(iss){
    h+='<p style="font-weight:600;margin-top:0.4rem">'+esc(iss.loc)+':</p><ul>';
    iss.items.forEach(function(item){h+='<li>'+esc(item)+'</li>'});
    h+='</ul>';
  });
  h+='</div>';
  return h;
}

/* ── Init ── */
(function(){
  var dates=Object.keys(R).sort().reverse();
  var sel=document.getElementById('ds');
  dates.forEach(function(d){
    var opt=document.createElement('option');opt.value=d;
    var rd=R[d]||{};var fc=rd.forecast_date||rd.date||d;
    opt.textContent=fc+' (v'+(rd.app_version||'?')+' \u00b7 '+(rd.generated_at||'')+')';
    sel.appendChild(opt);
  });
  sel.addEventListener('change',function(){render(sel.value)});
  if(dates.length)render(dates[0]);
})();
</script>
</body>
</html>
