# Обновление промпта и методики под «замкнутые маршруты с возвращением» в Альпах

## Сводка ваших уточнений и новых требований

Вы уточнили, что основная задача — **замкнутые маршруты (return-to-area/return-to-start)**, не обязательно FAI-треугольники, с приоритетом на **большие дни**, когда возможны **~200 км с возвращением**, и запасной формат **~100 км с возвращением**.

Приоритет районов (от «ближе и чаще» к «только если очень хорошо»):
- entity["place","Bavarian Alps","bavaria, germany"]: entity["city","Lenggries","Bavaria, Germany"] / entity["point_of_interest","Wallberg","Tegernsee, Bavaria, Germany"] (как базовый сценарий)
- entity["city","Kössen","Tyrol, Austria"]
- entity["state","Tyrol","state, austria"], entity["state","South Tyrol","autonomous province, italy"] и северная Италия
- entity["country","Switzerland","country"] и entity["country","Slovenia","country"] — только при «очень сильном» прогнозе
- entity["country","Czechia","country"] — исключаем

Логистика:
- **Соло-ретрив**, ранний выезд на старт — ок.
- Прогноз запускается **за пару дней** (первый прогон), возможно **подтверждение вечером накануне**; утром — редко.

Ваши *персональные* пороги/ограничения (как «default-настройки» агента):
- Замкнутый маршрут ⇒ **сильный фоновой ветер нежелателен**: фон **> 5 м/с** нежелателен.
- Порывы «локально» **больше ~10 (вероятно м/с)** нежелательны (прошу подтвердить размерность: вы написали «10 км/с», это физически не про ветер; ниже я буду трактовать как **10 м/с**).
- База/CBH должна быть **≥ 1000 м выше доминирующих вершин** в предполагаемом районе полёта.
- «Световое погодное окно» **> 5 часов**.
- «Слабый фён» — **ок**, сильные/опасные фён‑сценарии должны жёстко подсвечиваться.
- Переразвитие: **упоминать**, но если локально/пятнами — это не автоматически NO‑GO.
- Крыло спортивного класса, навыки **очень хорошие** ⇒ допускается более «жёсткая» работа с ветром/турбулентностью, но ваши пороги по ветру остаются ключевыми.

Требование к выдаче на *каждый прогон*: короткая таблица лучших вариантов + затем подробный разбор лучшего и более кратко остальных хороших; отдельный блок «сомнения/неуверенности».

## Нужен ли фиксированный список стартов, и могу ли я качественно оценивать без него

Короткий честный ответ: **для отбора региона — да, могу без списка стартов; для финального “GO/NO‑GO на конкретный старт” — желательно иметь хотя бы 1–3 якорные точки/старта на район**.

Почему так, особенно в Альпах:
- Решающее для замкнутых маршрутов — **ветер и его дневная эволюция в долинах/перевалах**, а это крайне топография‑зависимо. Диурнальные горно‑долинные ветра — термически обусловленная циркуляция, часто усиливаются днём и могут “переломить” даже при слабом синоптическом фоне. citeturn20search0
- Фён/волна/роторы — это режимы, где “в среднем по региону” может выглядеть нормально, а **в конкретной долине/под конкретным гребнем** будет опасно. Роторные зоны могут быть **сильными и разрушительными для контроля**, и их нельзя надёжно «усреднить». citeturn15view2turn24view1

Практичный компромисс, который не требует «полного каталога стартов»:
- **Не фиксированный список всех стартов**, а **короткий список “якорей”** (по 1–3 на район), каждый якорь = координата + высота старта + тип экспозиции (E/W/N/S) + “доминирующие вершины/гребни рядом”.
- На первом прогоне (T‑2 дня) агент делает **ранжирование районов** по “вероятности 200 км return‑day” и по рискам.
- На втором прогоне (вечер T‑1) агент уже смотрит **только 1–2 лучших района** и при необходимости просит вас выбрать из 1–2 стартов внутри района (или использует якорь по умолчанию).

Таким образом:
- **Без списка стартов** я могу дать уверенное *региональное* решение “куда ехать” и “какой район вообще имеет окно ≥5 часов и базу +1000 м”.
- **С якорями** я смогу дать гораздо более точный “GO/NO‑GO” и лучше различать, где “летно рядом” и где “середина по пути” действительно рациональна.

## Как ваши пороги меняют критерии для замкнутых маршрутов

Для “return‑to‑start / return‑to‑area” логика отличается от «улететь далеко по ветру»: сильный фоновой ветер — чаще враг, чем помощник.

**Фоновой ветер > 5 м/с (ваш порог)**  
Это разумно кодируется как:
- если **средний ветер на рабочей высоте** (условно слой “крест/переходы”) устойчиво > 5 м/с, то:
  - резко падает вероятность «красивого замкнутого 200 км» (будет перекос одной ноги),
  - растут риски «не вернуться в доступную зону посадок»,
  - возрастает турбулентность и ветровая деградация термиков.

**Порывы > 10 м/с (ваш порог)**  
Порывистость нужно оценивать не только “макс порыв”, а:
- **gust factor = gust − mean** (если разница большая, это чаще про турбулентность/сдвиги/вынос из долин),
- суточная фаза: часто самые неприятные порывы — при:
  - разрушении инверсии/усилении перемешивания,
  - позднем дне при выносе холодного воздуха/фён‑прорывах. citeturn24view3turn17view1

**Сдвиг ветра и турбулентность (особенно важны рядом с гребнями)**  
Для автоматического флага “вероятна турбулентность” можно использовать авиационное правило‑индикатор: турбулентность вероятна при вертикальном сдвиге порядка **≥ 5 kt на 1000 ft**, а в горной волне/за хребтом сдвиги усиливаются. citeturn24view0turn24view1  
Плюс: в условиях волны/ротора отсутствие красивых лентикуляров не гарантирует безопасность. citeturn24view1turn15view3

**Фён как “разрешённый слабый” vs “опасный”**  
Вы просите относиться к слабому фёну нормально, но он должен быть подсвечен. Это хорошая политика, если агент делает различие:
- **Слабый фён**: локальные усиления, но без признаков прорыва в долины “стеной”.
- **Опасный сценарий**: вероятен прорыв/ускорение в долинах, роторы/волна, резкие усиления у земли/на посадках.  
DHV‑материал по северному фёну подчёркивает, что даже умеренный северный ветер на ~700 гПа и сильный термодень могут приводить к **опасной приземной турбулентности** при прорыве в долины. citeturn17view1  
Общее определение фёна как тёплого сухого нисходящего ветра с рисками сильных порывов и сухости — фиксируем как “режим повышенного внимания”. citeturn20search4turn20search22

**Требование “база ≥ (доминирующая вершина +1000 м)”**  
Это критично для замкнутых больших дней: иначе вы будете вынуждены:
- идти низко над перевалами,
- терять опции безопасных глайдов,
- “передавливать” рискованные места.  
В промпте это надо формализовать как вычислимое условие: *минимальная база по району* должна превышать *(максимальную высоту рельефа в предполагаемом радиусе/коридоре + 1000 м)*.

**Окно ≥ 5 часов**  
Это условие важно кодировать строго: “окно” = непрерывный интервал, где одновременно:
- нет организованных осадков/грозовых триггеров,
- база и термодепс достаточны,
- ветер/порывы не выходят за пороги.  
Радар/nowcast нужен не утром “в последний момент”, а на этапе вечернего подтверждения, потому что radar‑продукты обновляются минутными/пятиминутными циклами и дают “реальность” по осадкам и развалу конвекции. citeturn18search0turn18search1turn18search37turn18search4

## Формат ответа агента для ваших прогонов T‑2 и T‑1 вечер

В промпте нужно жёстко задать структуру выдачи, чтобы она всегда была одинаковой и быстро читаемой.

**Секция “Короткая таблица лучших вариантов”**  
Таблица должна ранжировать варианты по районам/якорям и содержать:
- итог: GO / MARGINAL / NO‑GO
- “потенциал замкнутого 200 км” (High/Med/Low)
- окно (часы)
- база (min/typ, относительно доминирующих вершин)
- фоновой ветер (m/s) и порывы (m/s)
- фён (none/weak/concern) + краткий комментарий
- переразвитие (none/local/widespread)
- краткая причина ранга

**После таблицы**  
1) **Лучший вариант** — подробный разбор (почему лучший именно для return‑маршрута).  
2) **Остальные хорошие** — “средне подробно”: ключевые цифры + “что может сломать день”.  
3) **Блок сомнений** — отдельный: что неясно/что модели расходятся/что нужно подтвердить вечером.

**Два режима запуска**
- `initial (T-2 дня)`: больше упор на вероятность/разброс ансамблей, сценарии “если станет хуже/лучше”.
- `evening_confirmation (T-1 вечер)`: уже “оперативность”: уточнение окна, подтверждение ветра/осадков/переразвития, проверка, что “план завтра реалистичен”.

## Готовый многоразовый промпт-шаблон под ваши правила

Ниже — шаблон, который вы будете запускать на выбранный день (дата приходит как внешний параметр). Он **не требует полного списка стартов**, но поддерживает его, если вы захотите добавить “якоря”.

```text
ROLE
Ты — метео-аналитик для XC парапланеризма в Альпах. Твоя цель — выбрать лучший район/старт для ЗАМКНУТОГО маршрута (return-to-area/return-to-start), приоритет: день, когда реалистично ~200 км с возвращением. Вторичная цель: ~100 км с возвращением.

INPUTS (обязательные)
- date_of_interest: {YYYY-MM-DD}  (это внешний параметр вызова; не “зашивай” его в сам шаблон)
- mode: {initial | evening_confirmation}
- start_window_local: {например 09:30–11:30}
- latest_safe_landing_local: {например 17:00}
- minimum_weather_window_hours: 5
- task_type: "closed_loop_return" (не обязательно FAI)
- target_distance_km: {200; если нереалистично — предложи 100}
- retrieve_mode: "solo"
- drive_constraints:
  - base_city: "Munich"
  - max_drive_hours: 8
  - early_departure_ok: true
- region_priority (по убыванию):
  1) "Bavarian Alps: Lenggries/Wallberg"
  2) "Koessen"
  3) "Tyrol / South Tyrol / North Italy"
  4) "Switzerland"
  5) "Slovenia"
  excluded: ["Czechia"]
- pilot_profile:
  - skill_level: "very_high"
  - wing_class: "sport"
- wind_limits (твёрдые пороги пользователя):
  - background_wind_max_ms: 5.0          # если >5 м/с — резко снижать оценку return-маршрута
  - gust_max_ms: 10.0                    # если порывы >10 м/с — нежелательно
  - gust_factor_note: "если gust-mean большой, отмечай как турбулентность/сдвиг"
- cloudbase_rule:
  - cb_above_dominant_peaks_m: 1000      # база должна быть минимум на 1000 м выше доминирующих вершин в районе
- foehn_policy:
  - weak_foehn_ok: true
  - strong_foehn_no_go: true
- overdevelopment_policy:
  - mention_always: true
  - local_ok: true
  - widespread_no_go: true

OPTIONAL INPUTS (если есть, сильно улучшает точность)
- anchors (список якорных точек; можно пусто):
  - {name, lat, lon, takeoff_msl_m, dominant_peaks_msl_m (или radius_for_peak_check_km), typical_exposure}
- preferred_sources: {официальные и основные модели/радар/спутник/станции; перечисли}

REQUIRED ANALYSIS
1) Для каждого региона (и для каждого anchor, если задан):
   - Оцени: ветер (фон + порывы), вероятность осадков/гроз, базу и термальную глубину, риск фёна/волны/роторов, ожидаемое непрерывное лётное окно (>= 5 ч?).
   - Учитывай, что цель — ЗАМКНУТЫЙ маршрут: сильный направленный ветер ухудшает шанс вернуться.
2) Сравни несколько моделей и (если доступно) ансамбли: покажи где есть расхождения и как они влияют на решение.
3) Сделай итоговую ранжированную рекомендацию: куда ехать, и какой план “B” (следующий по качеству район).
4) В режиме evening_confirmation: отдельно проверь тренд переразвития/осадков и уточни границы окна.

OUTPUT FORMAT (строго)
A) Короткая таблица лучших вариантов (3–6 строк максимум).
B) Детально: лучший вариант (структура: GO/NO-GO, окно, ветер, база, термики, риски, план по времени, причины).
C) Средне подробно: остальные хорошие варианты.
D) Отдельно: "Сомнения/неуверенности" (если есть) + чем их можно закрыть вечером.
E) Если NO-GO везде — предложи “не лететь” и почему (конкретные параметры).
```

### Минимальные уточнения, которые всё ещё стоит зафиксировать (чтобы промпт был «железобетонным»)

Вы уже дали почти всё. Остались несколько вещей, которые реально влияют на качество автоматической оценки:

- Что именно означает “возвращение”: **в радиус X км от старта** (например ≤15–25 км), **в ту же долину**, или **на тот же LZ**?
- Подтвердите размерность: “порывы больше 10 км/с” — я трактую как **10 м/с**. Верно?
- “Доминирующие вершины”: вы хотите считать их **в радиусе** (например 30–50 км вокруг предполагаемого полигона/района) или по конкретному “коридору треугольника/петли”?
- Окно ≥5 часов: считать от момента старта или “с первого уверенного термика” (например с 11:00 до 16:00)?

Если вы ответите на эти 4 пункта, промпт можно считать практически финальным.